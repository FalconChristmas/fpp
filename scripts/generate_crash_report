#!/bin/bash
#
# Generate crash report with sensitive data removed
# Usage: generate_crash_report <crash_log_level> <output_filename>
#

CRASH_LOG_LEVEL=$1
OUTPUT_ZIP=$2

# Change to FPP media directory
cd /home/fpp/media || cd /opt/fpp || exit 1

# Make output path absolute if it's relative
if [[ "$OUTPUT_ZIP" != /* ]]; then
    OUTPUT_ZIP="/home/fpp/media/$OUTPUT_ZIP"
fi

# Ensure output directory exists
mkdir -p "$(dirname "$OUTPUT_ZIP")"

# Use media tmp directory instead of system /tmp to avoid space issues
TEMP_DIR=$(mktemp -d -p /home/fpp/media/tmp)

# Exit if temp directory creation failed
if [ ! -d "$TEMP_DIR" ]; then
    echo "Failed to create temporary directory"
    exit 1
fi

# Cleanup function
cleanup() {
    rm -rf "$TEMP_DIR"
}
trap cleanup EXIT

echo "Generating crash report in: $TEMP_DIR"

# Copy base crash log
cp /tmp/fppd_crash.log "$TEMP_DIR/" 2>/dev/null || true
cp fpp-info.json "$TEMP_DIR/" 2>/dev/null || true

# Level 2+: Include settings
if [ "$CRASH_LOG_LEVEL" -ge 2 ]; then
    echo "Including settings (with passwords redacted)..."
    
    # Handle settings file (single file)
    if [ -f "settings" ]; then
        # Redact password fields - match any field containing "password", "passwd", or "pwd"
        # This catches: osPasswordVerify, systemPassword, mqtt_password, PWD, etc.
        # BUT excludes fields ending in "Enable" (e.g., osPasswordEnable, passwordEnable)
        sed -E \
            -e '/[a-zA-Z_]*[Pp]assword[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]assword[a-zA-Z_]*)(\s*[:=]\s*)"[^"]+"/\1\2"**REDACTED**"/g' \
            -e "/[a-zA-Z_]*[Pp]assword[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]assword[a-zA-Z_]*)(\s*[:=]\s*)'[^']+'/\1\2'**REDACTED**'/g" \
            -e '/[a-zA-Z_]*[Pp]assword[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]assword[a-zA-Z_]*)(\s*[:=]\s*)([^"\047[:space:]]+)/\1\2**REDACTED**/g' \
            -e '/[a-zA-Z_]*[Pp]asswd[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]asswd[a-zA-Z_]*)(\s*[:=]\s*)"[^"]+"/\1\2"**REDACTED**"/g' \
            -e "/[a-zA-Z_]*[Pp]asswd[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]asswd[a-zA-Z_]*)(\s*[:=]\s*)'[^']+'/\1\2'**REDACTED**'/g" \
            -e '/[a-zA-Z_]*[Pp]asswd[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]asswd[a-zA-Z_]*)(\s*[:=]\s*)([^"\047[:space:]]+)/\1\2**REDACTED**/g' \
            -e '/[a-zA-Z_]*[Pp]wd[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]wd[a-zA-Z_]*)(\s*[:=]\s*)"[^"]+"/\1\2"**REDACTED**"/g' \
            -e "/[a-zA-Z_]*[Pp]wd[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]wd[a-zA-Z_]*)(\s*[:=]\s*)'[^']+'/\1\2'**REDACTED**'/g" \
            -e '/[a-zA-Z_]*[Pp]wd[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]wd[a-zA-Z_]*)(\s*[:=]\s*)([^"\047[:space:]]+)/\1\2**REDACTED**/g' \
            "settings" > "$TEMP_DIR/settings" 2>/dev/null || \
        cp "settings" "$TEMP_DIR/settings"
    fi
    
    # Handle settings directory (multiple files)
    if [ -d "settings" ]; then
        mkdir -p "$TEMP_DIR/settings"
        for file in settings/*; do
            if [ -f "$file" ]; then
                filename=$(basename "$file")
                
                # Redact password fields - match any field containing "password", "passwd", or "pwd"
                # BUT excludes fields ending in "Enable" (e.g., osPasswordEnable, passwordEnable)
                sed -E \
                    -e '/[a-zA-Z_]*[Pp]assword[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]assword[a-zA-Z_]*)(\s*[:=]\s*)"[^"]+"/\1\2"**REDACTED**"/g' \
                    -e "/[a-zA-Z_]*[Pp]assword[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]assword[a-zA-Z_]*)(\s*[:=]\s*)'[^']+'/\1\2'**REDACTED**'/g" \
                    -e '/[a-zA-Z_]*[Pp]assword[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]assword[a-zA-Z_]*)(\s*[:=]\s*)([^"\047[:space:]]+)/\1\2**REDACTED**/g' \
                    -e '/[a-zA-Z_]*[Pp]asswd[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]asswd[a-zA-Z_]*)(\s*[:=]\s*)"[^"]+"/\1\2"**REDACTED**"/g' \
                    -e "/[a-zA-Z_]*[Pp]asswd[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]asswd[a-zA-Z_]*)(\s*[:=]\s*)'[^']+'/\1\2'**REDACTED**'/g" \
                    -e '/[a-zA-Z_]*[Pp]asswd[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]asswd[a-zA-Z_]*)(\s*[:=]\s*)([^"\047[:space:]]+)/\1\2**REDACTED**/g' \
                    -e '/[a-zA-Z_]*[Pp]wd[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]wd[a-zA-Z_]*)(\s*[:=]\s*)"[^"]+"/\1\2"**REDACTED**"/g' \
                    -e "/[a-zA-Z_]*[Pp]wd[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]wd[a-zA-Z_]*)(\s*[:=]\s*)'[^']+'/\1\2'**REDACTED**'/g" \
                    -e '/[a-zA-Z_]*[Pp]wd[Ee]nable\s*[:=]/! s/([a-zA-Z_]*[Pp]wd[a-zA-Z_]*)(\s*[:=]\s*)([^"\047[:space:]]+)/\1\2**REDACTED**/g' \
                    "$file" > "$TEMP_DIR/settings/$filename" 2>/dev/null || \
                cp "$file" "$TEMP_DIR/settings/$filename"
            fi
        done
    fi
    
    # Level 3: Include config, logs, etc.
    if [ "$CRASH_LOG_LEVEL" -ge 3 ]; then
        echo "Including detailed logs and config..."
        
        # Boot logs
        mkdir -p "$TEMP_DIR/tmp"
        dmesg -T > "$TEMP_DIR/tmp/boot.log" 2>/dev/null || true
        journalctl -b -u fppinit -u fppoled -u fpp_postnetwork >> "$TEMP_DIR/tmp/boot.log" 2>/dev/null || true
        
        # Config directory (scrub sensitive files)
        if [ -d "config" ]; then
            mkdir -p "$TEMP_DIR/config"
            for file in config/*; do
                if [ -f "$file" ]; then
                    filename=$(basename "$file")
                    
                    # Skip or redact files that commonly contain credentials
                    case "$filename" in
                        *authorized_keys*|*id_rsa*|*id_dsa*|*.pem|*.key)
                            echo "**REDACTED SSH/KEY FILE**" > "$TEMP_DIR/config/$filename"
                            ;;
                        *)
                            # Scrub passwords from other config files
                            sed -E \
                                -e 's/(password|passwd|pwd|Pass|PWD|PASS)(\s*[:=]\s*)"[^"]+"/\1\2"**REDACTED**"/gI' \
                                -e "s/(password|passwd|pwd|Pass|PWD|PASS)(\s*[:=]\s*)'[^']+'/\1\2'**REDACTED**'/gI" \
                                -e 's/(password|passwd|pwd|Pass|PWD|PASS)(\s*[:=]\s*)([^"\047[:space:]]+)/\1\2**REDACTED**/gI' \
                                "$file" > "$TEMP_DIR/config/$filename" 2>/dev/null || \
                            cp "$file" "$TEMP_DIR/config/$filename"
                            ;;
                    esac
                fi
            done
        fi
        
        # Logs (scrub any passwords that might appear in logs)
        mkdir -p "$TEMP_DIR/logs"
        if [ -f "logs/fppd.log" ]; then
            sed -E \
                -e 's/(password|passwd|pwd|Pass|PWD|PASS)(\s*[:=]\s*)"[^"]+"/\1\2"**REDACTED**"/gI' \
                -e "s/(password|passwd|pwd|Pass|PWD|PASS)(\s*[:=]\s*)'[^']+'/\1\2'**REDACTED**'/gI" \
                -e 's/(password|passwd|pwd|Pass|PWD|PASS)(\s*[:=]\s*)([^"\047[:space:]]+)/\1\2**REDACTED**/gI' \
                "logs/fppd.log" > "$TEMP_DIR/logs/fppd.log" 2>/dev/null || true
        fi
        if [ -f "logs/apache2-error.log" ]; then
            sed -E \
                -e 's/(password|passwd|pwd|Pass|PWD|PASS)(\s*[:=]\s*)"[^"]+"/\1\2"**REDACTED**"/gI' \
                -e "s/(password|passwd|pwd|Pass|PWD|PASS)(\s*[:=]\s*)'[^']+'/\1\2'**REDACTED**'/gI" \
                -e 's/(password|passwd|pwd|Pass|PWD|PASS)(\s*[:=]\s*)([^"\047[:space:]]+)/\1\2**REDACTED**/gI' \
                "logs/apache2-error.log" > "$TEMP_DIR/logs/apache2-error.log" 2>/dev/null || true
        fi
        
        # Playlists (scrub any embedded credentials in URLs)
        if [ -d "playlists" ]; then
            mkdir -p "$TEMP_DIR/playlists"
            for file in playlists/*; do
                if [ -f "$file" ]; then
                    filename=$(basename "$file")
                    # Redact credentials in URLs: http://user:pass@host -> http://**REDACTED**@host
                    sed -E 's#(https?://)[^:/@]+:[^@]+@#\1**REDACTED**@#gI' "$file" > "$TEMP_DIR/playlists/$filename" 2>/dev/null || \
                    cp "$file" "$TEMP_DIR/playlists/$filename"
                fi
            done
        fi
        
        # /etc/fpp (scrub sensitive data)
        if [ -d "/etc/fpp" ]; then
            mkdir -p "$TEMP_DIR/etc_fpp"
            for file in /etc/fpp/*; do
                if [ -f "$file" ]; then
                    filename=$(basename "$file")
                    sed -E \
                        -e 's/(password|passwd|pwd|Pass|PWD|PASS)(\s*[:=]\s*)"[^"]+"/\1\2"**REDACTED**"/gI' \
                        -e "s/(password|passwd|pwd|Pass|PWD|PASS)(\s*[:=]\s*)'[^']+'/\1\2'**REDACTED**'/gI" \
                        -e 's/(password|passwd|pwd|Pass|PWD|PASS)(\s*[:=]\s*)([^"\047[:space:]]+)/\1\2**REDACTED**/gI' \
                        "$file" > "$TEMP_DIR/etc_fpp/$filename" 2>/dev/null || \
                    cp "$file" "$TEMP_DIR/etc_fpp/$filename"
                fi
            done
        fi
    fi
fi

# Create the zip file
cd "$TEMP_DIR"
zip -r "$OUTPUT_ZIP" . >/dev/null 2>&1

echo "Crash report created: $OUTPUT_ZIP"
exit 0
