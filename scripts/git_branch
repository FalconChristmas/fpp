#!/bin/bash

BINDIR=$(cd $(dirname $0) && pwd)

. ${BINDIR}/common
. ${BINDIR}/functions

if [ "x$1" = "x" ]
then
	echo "USAGE: $0 BRANCHNAME [REMOTE]"
	exit 1
fi

# Get the remote name, default to 'origin'
REMOTE=${2:-origin}

teeOutput

echo "$0 running to switch branches to $1 from remote $REMOTE"

CNT=`cd ${FPPDIR} && git show-ref | grep "refs/remotes/$REMOTE" | grep -i $1 | wc -l`
if [ $CNT -eq 0 ]; then
	echo "Invalid Branch Name: $1 for remote: $REMOTE"
	exit 1
fi

echo "Stopping fppd"
${SUDO} ${FPPDIR}/scripts/fppd_stop

echo "Cleaning up any compiled binaries"
cleanCompiledBinaries

echo "Switching git branch to $1 from remote $REMOTE"
if [ "x${FPPDIR}" = "x/opt/fpp" ]
then
	cd ${FPPDIR} && $SUDO git clean -df && $SUDO git reset --hard &&  $SUDO git submodule foreach git reset --hard && $SUDO git fetch $REMOTE && $SUDO git checkout -B $1 $REMOTE/$1 && $SUDO git pull $REMOTE $1 && git fetch --tags -f && $SUDO git submodule sync && $SUDO git submodule update --init
else
	cd ${FPPDIR} && sudo git clean -df && sudo -u ${FPPUSER} git reset --hard && $SUDO -u ${FPPUSER} git submodule foreach git reset --hard && sudo -u ${FPPUSER} git fetch $REMOTE && sudo -u ${FPPUSER} git checkout -B $1 $REMOTE/$1 && sudo -u ${FPPUSER} git pull $REMOTE $1 && sudo -u ${FPPUSER} git submodule sync && sudo git submodule update --init
fi

${SUDO} ${SCRIPTDIR}/upgrade_config

echo "Compiling Binaries"
compileBinaries

# Delete any statistics
/usr/bin/curl -X DELETE http://localhost/api/statistics/usage

# If apache config file has changed copy across from branch standard
if [ -f ${FPPDIR}/etc/apache2.site ] && ! cmp -s ${FPPDIR}/etc/apache2.site /etc/apache2/sites-available/000-default.conf
then
	echo "Updating apache2 site configuration"
	${SUDO} cp ${FPPDIR}/etc/apache2.site /etc/apache2/sites-available/000-default.conf
fi


echo "Restarting fppd"
${SUDO} ${FPPDIR}/scripts/fppd_start

