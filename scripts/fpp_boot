#!/bin/bash

BINDIR=$(cd $(dirname $0) && pwd)

# See if we should be running from /home/fpp/fpp
if [ "x${BINDIR}" == "x/opt/fpp/scripts" -a -f "/home/fpp/fpp/scripts/fpp_boot" ]
then
    exec /home/fpp/fpp/scripts/fpp_boot
fi

. ${BINDIR}/common
. ${BINDIR}/functions

if [ ! -d ${LOGDIR} ]
then
	mkdir -p ${LOGDIR}
	chown ${FPPUSER}.${FPPUSER} ${LOGDIR}
	chmod 775 ${LOGDIR}
fi

if [ ! -f "${MEDIADIR}/.auto_update_disabled" ]
then
    WaitForInterfacesUp
	${SCRIPTDIR}/git_pull
fi

${SCRIPTDIR}/upgrade_config

${SCRIPTDIR}/timezone_sync

if [ "${FPPPLATFORM}" = "Raspberry Pi" ]
then
        PiLCDenabled=$(getSetting PI_LCD_Enabled)

        if [ "x${PiLCDenabled}" = "x1" ]
        then
          echo "FPP - Checking for configured LCD, LCD Enabled, starting LCD daemon"
          ${FPPDIR}/scripts/lcd/fppLCD start
        else
          echo "FPP - Checking for configured LCD, LCD Disabled"
        fi
fi

WaitForInterfacesUp

MaybeEnableTethering

# Print/Say the IP address
if [ -f /usr/bin/flite ]
then
	_IP=$(hostname -I) || true
	if [ "$_IP" ]; then
		echo "FPP - Found IP(s): $_IP"

		DISABLEIPANN=$(getSetting disableIPAnnouncement)
		if [ "x${DISABLEIPANN}" != "x1" ]
		then
			arrHost=(${_IP// / })
			FLITESTR="I Have Found The Following I P Addresses, ${arrHost[0]}, ${arrHost[1]},  ${arrHost[2]}"
			if [ "${FPPPLATFORM}" = "BeagleBone Black" ]
			then
				(flite -voice awb -o /var/tmp/flite.wav "${FLITESTR}" && mplayer -ao alsa /var/tmp/flite.wav) &
			else
				flite -voice awb "${FLITESTR}" &
			fi
		fi
	else
		echo "FPP - No IP(s) found"
	fi
fi

SLEEPSECS=$(getSetting bootDelay)
if [ "x${SLEEPSECS}" != "x" ]
then
	sleep ${SLEEPSECS}
fi

if [ "${FPPPLATFORM}" = "Raspberry Pi" ]
then
	echo "FPP - Setting up SPI"
    modprobe spidev

    if [ ! -e /dev/spidev0.0 ]; then
        sleep 0.5
    fi

	# See if we have a PiFace connected
	echo "FPP - Checking for PiFace"
	detectPiFace

	# See if we have any Falcon hardware on the SPI port
	echo "FPP - Checking for Falcon hardware on SPI port"
	detectFalconHardware
fi

# set the Source port for outgoing ARTNET packets to match the spec
/sbin/iptables -t nat -I POSTROUTING -p udp --dport 6454 -j SNAT --to-source :6454
