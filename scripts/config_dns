#!/bin/bash
#############################################################################

BINDIR=$(cd $(dirname $0) && pwd)
. ${BINDIR}/common

logOutput

if [ -f "/usr/sbin/connmanctl" ]; then
    echo "Using Connection Manager, DNS setup with interfaces"
    exit 0
fi
if [ -f "/usr/sbin/connmanctl" ]; then
    echo "Using Connection Manager, DNS setup with interfaces"
    exit 0
fi


if [ -f "${CFGDIR}/dns" ]; then
  . ${CFGDIR}/dns
  sed -i "/dns-nameservers/d" /etc/network/interfaces
  for IFACE in eth0 wlan0; do
    if [ "`resolvconf -f -l ${IFACE} | grep -c 'Generated by fpp'`" == "1" ]; then
      resolvconf -f -d ${IFACE}
    fi
  done
  if [ "${DNS1}" != "" -o "${DNS2}" != "" ]; then
    for IFACE in eth0 wlan0; do
      . ${CFGDIR}/interface.${IFACE}
      if [ "${PROTO,,}" == "static" ]; then
        sed -i "/${IFACE} inet static/a \ \ dns-nameservers ${DNS1} ${DNS2}" /etc/network/interfaces
        TMPFILE=`mktemp`
        echo "# Generated by fpp" > ${TMPFILE}
        if [ "${DNS1}" != "" ]; then
          echo "nameserver ${DNS1}" >> ${TMPFILE}
        fi
        if [ "${DNS2}" != "" ]; then
          echo "nameserver ${DNS2}" >> ${TMPFILE}
        fi
        cat ${TMPFILE} | resolvconf -f -a ${IFACE}
        rm -f ${TMPFILE}
      fi
    done
  fi
fi

resolvconf -f -l

